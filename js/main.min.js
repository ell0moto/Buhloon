/*! Buhloon built on 2013-04-29 by Matthew Maher <matthew.alexander.maher@gmail.com */
"use strict";var app=angular.module("App",["Controllers","Filters","Services","Directives","ngResource","ngCookies","ui","ui.bootstrap"]);angular.module("Controllers",[]),angular.module("Services",[]),angular.module("Directives",[]),angular.module("Filters",[]),app.config(["$routeProvider","$locationProvider",function(e,n){n.html5Mode(!0).hashPrefix("!"),e.when("/",{templateUrl:"home_index.html",controller:"HomeIndexCtrl"}).when("/main",{templateUrl:"main_index.html",controller:"MainIndexCtrl"}).otherwise({redirectTo:"/"})}]),app.run(["$rootScope","$cookies","$http",function(e,n,o){e.$watch(function(){return n[serverVars.csrfCookieName]},function(){o.defaults.headers.common["X-XSRF-TOKEN"]=n[serverVars.csrfCookieName]})}]),angular.module("Controllers").controller("HeaderPartialCtrl",["$scope","$location","UsersServ","RewardsServ","ChildrenServ","PlansServ","NotificationsServ",function(e,n,o,t,r,i,a){e.closeAlert=function(n){e.alerts.splice(n,1)},e.openRewards=function(){e.rewardsBox=!0},e.closeRewards=function(){e.rewardsBox=!1},e.openPlans=function(){e.plansBox=!0},e.closePlans=function(){e.plansBox=!1},e.openActivity=function(){e.activityBox=!0},e.closeActivity=function(){e.activityBox=!1},e.items=["item1","item2"],e.opts={backdropFade:!0,dialogFade:!0},e.$watch(function(){return t.getRewards()},function(){e.rewards=t.getRewards(),console.log("rewards Header firing")}),e.$watch(function(){return a.getNotification()},function(){e.notifications=a.getNotification(),console.log("notifications Header firing")}),e.submitReward=function(){var n={titleOfReward:e.titleOfReward,ribbonCost:e.ribbonCost};t.server.save({},n,function(n){console.log(n,"<- SAVE");var o={id:n.content,titleOfReward:e.titleOfReward,ribbonCost:e.ribbonCost};n?t.setNewReward(o):console.log("Response did not get picked up")})},e.removeReward=function(e){t.server.remove({id:e},function(n){console.log(n,"<- REMOVE"),n?t.deleteReward(e):console.log("Response did not get picked up")})},e.submitPlan=function(){var n;n=e.existingUser?e.existingUser:e.nameOfChild;var o={titleOfPlan:e.titleOfPlan,description:e.description,nameOfChild:n,totalIteration:e.totalIteration,specificReward:e.specificReward,noRibbon:e.noRibbon,progress:0,active:0,complete:0};i.server.save({},o,function(o){if(console.log(o,"<- SAVE"),o){console.log(o);var t={titleOfPlan:e.titleOfPlan,description:e.description,nameOfChild:n,totalIteration:e.totalIteration,specificReward:e.specificReward,noRibbon:e.noRibbon,progress:0,active:0,complete:0,id:o.content.id,userId:o.content.userId,childId:o.content.childId};r.createPlanChild(t)}else console.log("Response did not get picked up")})},e.$watch(function(){return r.getChildren()},function(){e.children=r.getChildren(),console.log("children Header firing")}),e.removeNotification=function(e){var n={active:0,id:e};a.server.remove({id:0},n,function(e){e?(a.removeNotifiction(n),console.log(e,"<- SOFT DELETE")):console.log("Response did not get picked up")})},e.login=function(){var t={username:e.username,password:e.password};e.loginErrors=[],e.validationErrors={},o.loginSession(t,function(e){console.log("Successfully Logged In"),o.setUserData("id",e.content),n.path("/main")},function(n){console.log("Could not log in"),"validation_error"===n.data.code&&(Array.isArray(n.data.content)?e.loginErrors=n.data.content:e.validationErrors={username:n.data.content.username,password:n.data.content.password,rememberMe:n.data.content.rememberMe}),e.alerts=[{type:"error",msg:"This is unfortunate, your login and/or password is incorrect"}]})},e.logout=function(){o.logoutSession(o.getUserData().id),n.path("/")},e.$on("authenticationProvided",function(){e.state=!0}),e.$on("authenticationLogout",function(){e.state=!1})}]).controller("RewardsSubCtrl",["$scope","IncentivesServ",function(){}]).controller("ActivitySubCtrl",["$scope","NotificationsServ",function(e,n){e.isCollapsed=!0,e.get=function(){n.get({},function(n){e.notifications=n.content,console.log(n,"<- QUERY")},function(){console.log("Error! Well this is hawkard")})}}]),angular.module("Controllers").controller("HomeIndexCtrl",["$scope","UsersServ",function(e,n){e.closeAlert=function(n){e.alerts.splice(n,1)},e.register=function(){var o={username:e.createUserName,password:e.createPassword};e.loginErrors=[],e.validationErrors={},n.registerAccount(o,function(e){console.log("Successfully Created account"),n.setUserData("id",e.content)},function(n){console.log("Could not log in"),"validation_error"===n.data.code&&(Array.isArray(n.data.content)?e.loginErrors=n.data.content:e.validationErrors={username:n.data.content.username,password:n.data.content.password,rememberMe:n.data.content.rememberMe}),e.alerts=[{type:"error",msg:"This is unfortunate, please note your user name may already be taken & passwords should be longer than 8 characters"}]})}}]),angular.module("Controllers").controller("MainIndexCtrl",["$scope","ChildrenServ","PlansServ","RewardsServ","NotificationsServ",function(e,n,o,t,r){e.closeAlert=function(n){e.alerts.splice(n,1)},n.server.get({},function(t){var r=t.content;o.server.get({},function(o){n.setChildrenPlans(r,o.content),e.children=n.getChildren()},function(){console.log("Error! rewards")})},function(){console.log("Error! No children"),e.alerts=[{type:"success",msg:"Hey there you are, let's get started by creating a goal or plan with 'Add New' found above this message."}]}),e.$watch(function(){return r.getNotification()},function(){e.notifications=r.getNotification()},!0),e.$watch(function(){return n.getChildren()},function(){e.children=n.getChildren(),console.log("children Main firing")},!0),t.server.get({},function(e){t.setRewards(e.content),console.log(e,"<- QUERY")},function(){console.log("Error! rewards")}),e.$watch(function(){return t.getRewards()},function(){e.rewards=t.getRewards(),console.log("rewards Main firing")}),r.server.get({},function(e){r.setNotifications(e.content),console.log(e,"<- QUERY")},function(){console.log("Error! Well this is hawkard")}),e.$watch(function(){return r.getNotification()},function(){e.notifications=r.getNotification()})}]).controller("ChildrenSubCtrl",["$scope","PlansServ","ChildrenServ","RewardsServ",function(e,n,o,t){e.isCollapsed=!0,e.purchase=function(e,n){if(o.getRibbons(n)-t.getCosts(e)>0){var r={id:n,netRibbon:o.getRibbons(n),ribbonCost:t.getCosts(e)};o.server.update({id:0},r,function(e){console.log(e,"<- UPDATE"),e?o.setRibbons(r.id,r.netRibbon,r.ribbonCost):console.log("Response did not get picked up")})}else console.log("failed")},e.removePlan=function(e){n.server.remove({id:e},function(n){console.log(n,"<- REMOVE"),n?o.deletePlan(e):console.log("Response did not get picked up")})}}]).controller("PlansSubCtrl",["$scope","PlansServ","ChildrenServ","NotificationsServ",function(e,n,o,t){e.plan.percent=100*(e.plan.progress/e.plan.totalIteration)+"%",e.plan.colour="#"+(16777215*Math.random()<<0).toString(16),e.updateProgress=function(e){e.progress=e.progress+1,e.active=1,e.progress===e.totalIteration&&(e.complete=1);var r=e.colour;delete e.colour,delete e.percent,n.server.update({id:0},e,function(n){console.log(n,"<- UPDATE"),n?(e.colour=r,e.percent=100*(e.progress/e.totalIteration)+"%",o.updateProgress(e),t.server.get({},function(e){t.setNotifications(e.content),console.log(e,"<- QUERY")},function(){console.log("Error! Well this is hawkard")})):console.log("Response did not get picked up")})}}]),angular.module("Directives").directive("animateBar",[function(){return{scope:!0,link:function(e,n){n.bind("mouseenter",function(){n.removeClass().addClass("progress progress-striped active")}),n.bind("mouseout",function(){n.removeClass().addClass("progress")})}}}]),angular.module("Directives").directive("modalBoxDir",["$parse","$dialog",function(e,n){return{restrict:"EA",terminal:!0,link:function(o,t,r){var i,a=angular.extend({},o.$eval(r.uiOptions||r.bsOptions||r.options)),s=r.modal||r.show;a=angular.extend(a,{template:t.html(),resolve:{$scope:function(){return o}}});var c=n.dialog(a);t.remove(),i=r.close?function(){e(r.close)(o)}:function(){angular.isFunction(e(s).assign)&&e(s).assign(o,!1)},o.$watch(s,function(e){e?c.open().then(function(){i()}):c.isOpen()&&c.close()})}}}]),angular.module("Directives").directive("placeHolderDir",[function(){return{restrict:"A",require:"ngModel",link:function(e,n,o,t){var r,i=function(){n.val(o.placeHolderDir)},a=function(){n.val("")};e.$watch(o.ngModel,function(e){r=e||""}),n.bind("focus",function(){""===r&&a()}),n.bind("blur",function(){""===n.val()&&i()}),t.$formatters.unshift(function(e){return e?e:(i(),r="",o.placeHolderDir)})}}}]),angular.module("Services").factory("AccountsServ",["$resource",function(e){return e("api/accounts/:id",{},{update:{method:"PUT"}})}]),angular.module("Services").config(["$httpProvider",function(e){e.responseInterceptors.push(["$q","$location",function(e,n){return function(o){return o.then(function(e){return e},function(o){return 403===o.status&&(console.log(o),n.path("/")),e.reject(o)})}}])}]),angular.module("Services").factory("ChildrenServ",["$resource",function(e){var n=[];return{getChildren:function(){return n},setChildrenPlans:function(e,o){for(var t=0;e.length>t;t++){for(var r=[],i=0;o.length>i;i++)e[t].id===o[i].childId&&r.push(o[i]);e[t].plans=r}n=e},createPlanChild:function(e){for(var o=0;n.length>o;o++)if(n[o].nameOfChild===e.nameOfChild)return n[o].plans.push(e),void 0;var t={id:e.childId,userId:e.userId,nameOfChild:e.nameOfChild,totalRibbon:0,spentRibbon:0,netRibbon:0,totalPlan:0},r=[];r.push(e),t.plans=r,n.push(t)},deletePlan:function(e){for(var o=0;n.length>o;o++)for(var t=n[o].plans,r=0;t.length>r;r++)if(t[r].id===e){t.splice(r,1);break}},updateProgress:function(e){for(var o=0;n.length>o;o++)for(var t=n[o].plans,r=0;t.length>r;r++)t[r].id===e.id&&(n[o].plans[r]=e);console.log(n)},getRibbons:function(e){for(var o=0;n.length>o;o++)if(n[o].id===e)return n[o].netRibbon},setRibbons:function(e,o,t){for(var r=0;n.length>r;r++)n[r].id===e&&(n[r].spentRibbon=n[r].spentRibbon+t,n[r].netRibbon=n[r].netRibbon-t)},server:e("api/offspring/:id",{},{update:{method:"PUT"}})}}]),angular.module("Services").factory("NotificationsServ",["$resource",function(e){var n=[];return{getNotification:function(){return n},setNotifications:function(e){for(var o=0;e.length>o;o++)e[o].percent=100*(e[o].progress/e[o].totalIteration)+"%";n=e},removeNotifiction:function(e){for(var o=0;n.length>o;o++)n[o].id===e.id&&(n[o].active=0);console.log(n)},server:e("api/notifications/:id",{},{update:{method:"PUT"}})}}]),angular.module("Services").factory("PlansServ",["$resource",function(e){return{server:e("api/operations/:id",{},{update:{method:"PUT"}})}}]),angular.module("Services").factory("RewardsServ",["$resource",function(e){var n=[];return{getRewards:function(){return n},setRewards:function(e){n=e},setNewReward:function(e){n.push(e)},deleteReward:function(e){for(var o=0;n.length>o;o++)if(n[o].id===e){n.splice(o,1);break}},getCosts:function(e){for(var o=0;n.length>o;o++)if(n[o].id===e)return n[o].ribbonCost},server:e("api/incentives/:id",{},{update:{method:"PUT"}})}}]),angular.module("Services").factory("SessionsServ",["$resource",function(e){return e("api/sessions/:id",{},{update:{method:"PUT"}})}]),angular.module("Services").config(["$httpProvider",function(e){e.responseInterceptors.push(["$q","$rootScope",function(e,n){return function(o){return o.then(function(e){return e},function(o){if(401===o.status||403===o.status){var t=e.defer(),r={config:o.config,deferred:t};return n.$broadcast("authenticationPartial",r),t.promise}return e.reject(o)})}}])}]).provider("UsersServ",function(){var e={},n="",o="/auth",t=!1,r=[];this.setLoginPage=function(e){o=e},this.$get=["$rootScope","$location","$http","AccountsServ","SessionsServ",function(i,a,s,c,l){var u={getUserData:function(){return e},setUserData:function(n){angular.extend(e,n)},registerAccount:function(e,n,o){c.save({},e,function(o){i.$broadcast("authenticationRegister",e),"function"==typeof n&&n(o)},function(e){"function"==typeof o&&o(e)})},deleteAccount:function(e,n,o){c.remove({id:e},function(o){i.$broadcast("authenticationDestroy",e),"function"==typeof n&&n(o)},function(e){"function"==typeof o&&o(e)})},getAccount:function(n,o,t){c.get({id:n},function(n){e=n.content,i.$broadcast("authenticationProvided",e),"function"==typeof o&&o(n)},function(e){"function"==typeof t&&t(e)})},loginSession:function(e,n,o){l.save({},e,function(e){i.$broadcast("authenticationLogin",e.content),"function"==typeof n&&n(e)},function(e){"function"==typeof o&&o(e)})},logoutSession:function(n,o,t){l.remove({id:n},function(n){i.$broadcast("authenticationLogout",n.content),e={},"function"==typeof o&&o(n)},function(e){"function"==typeof t&&t(e)})},getSession:function(e,n,o){l.get({id:e},function(e){e.content.userId!==void 0&&i.$broadcast("authenticationLogin",e.content.userId),"function"==typeof n&&n(e)},function(e){"function"==typeof o&&o(e)})}};return i.$on("authenticationPartial",function(o,i){0===Object.keys(e).length&&(n="",t=!0,r.push(i))}),i.$on("authenticationFull",function(){0===Object.keys(e).length&&(n=a.path,a.path(o))}),i.$on("authenticationRegister",function(e,o){n="/main",u.loginSession({username:o.username,password:o.password})}),i.$on("authenticationDestroy",function(e,o){n="/",u.logoutSession(o)}),i.$on("authenticationLogin",function(e,o){u.getAccount(o),n&&(a.path(n),n="/main");var i=function(e){s(e.config).then(function(n){e.deferred.resolve(n)},function(n){e.deferred.reject(n)})};if(t){for(var c=0;r.length>c;c++)i(r[c]);t=!1,r=[]}}),i.$on("authenticationLogout",function(){n&&(a.path(n),n="/")}),u}]}).run(["UsersServ",function(e){e.getSession(0)}]);