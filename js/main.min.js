/*! Buhloon built on 2013-05-15 by Matthew Maher <matthew.alexander.maher@gmail.com */
"use strict";var app=angular.module("App",["Controllers","Filters","Services","Directives","ngResource","ngCookies","ui","ui.bootstrap"]);angular.module("Controllers",[]),angular.module("Services",[]),angular.module("Directives",[]),angular.module("Filters",[]),app.config(["$routeProvider","$locationProvider",function(e,t){t.html5Mode(!0).hashPrefix("!"),e.when("/",{templateUrl:"home_index.html",controller:"HomeIndexCtrl"}).when("/main",{templateUrl:"main_index.html",controller:"MainIndexCtrl"}).otherwise({redirectTo:"/"})}]),app.run(["$rootScope","$cookies","$http",function(e,t,n){e.$watch(function(){return t[serverVars.csrfCookieName]},function(){n.defaults.headers.common["X-XSRF-TOKEN"]=t[serverVars.csrfCookieName]})}]),angular.module("Controllers").controller("HeaderPartialCtrl",["$scope","$location","UsersServ","RewardsServ","ChildrenServ","PlansServ","NotificationsServ",function(e,t,n,o,r,i,a){e.closeAlert=function(t){e.alerts.splice(t,1)},e.openRewards=function(){e.rewardsBox=!0},e.closeRewards=function(){e.rewardsBox=!1},e.openPlans=function(){e.plansBox=!0},e.closePlans=function(){e.plansBox=!1},e.openActivity=function(){e.activityBox=!0},e.closeActivity=function(){e.activityBox=!1},e.items=["item1","item2"],e.opts={backdropFade:!0,dialogFade:!0},e.$watch(function(){return o.getRewards()},function(){e.rewards=o.getRewards()}),e.$watch(function(){return a.getNotification()},function(){e.notifications=a.getNotification()}),e.submitReward=function(){var t={titleOfReward:e.titleOfReward,ribbonCost:parseInt(e.ribbonCost,10)},n=o.formCheck(t);if(!n.status){var r=[n];return e.dialog=r,setTimeout(function(){e.dialog.splice(0,1)},6e3),void 0}o.server.save({},t,function(t){console.log(t,"<- SAVE");var n={id:t.content,titleOfReward:e.titleOfReward,ribbonCost:e.ribbonCost};t?o.setNewReward(n):console.log("Response did not get picked up")})},e.removeReward=function(e){o.server.remove({id:e},function(t){console.log(t,"<- REMOVE"),t?o.deleteReward(e):console.log("Response did not get picked up")})},e.submitPlan=function(){var t;t=e.nameOfChild?e.nameOfChild:e.existingUser;var n={titleOfPlan:e.titleOfPlan,description:e.description,nameOfChild:t,totalIteration:parseInt(e.totalIteration,10),specificReward:e.specificReward,noRibbon:parseInt(e.noRibbon,10),progress:0,active:0,complete:0},o=i.formCheck(n);if(!o.status){var a=[o];return e.dialog=a,setTimeout(function(){e.dialog.splice(0,1)},6e3),void 0}i.server.save({},n,function(n){if(console.log(n,"<- SAVE"),n){var o={titleOfPlan:e.titleOfPlan,description:e.description,nameOfChild:t,totalIteration:parseInt(e.totalIteration,10),specificReward:e.specificReward,noRibbon:parseInt(e.noRibbon,10),progress:0,active:0,complete:0,id:n.content.id,userId:n.content.userId,childId:n.content.childId};r.createPlanChild(o),e.plansBox=!1}else console.log("Response did not get picked up")})},e.$watch(function(){return r.getChildren()},function(){e.children=r.getChildren()}),e.removeNotification=function(e){var t={active:0,id:e};a.server.remove({id:0},t,function(e){e?(a.removeNotifiction(t),console.log(e,"<- SOFT DELETE")):console.log("Response did not get picked up")})},e.login=function(){var o={username:e.username,password:e.password};e.loginErrors=[],e.validationErrors={},n.loginSession(o,function(o){console.log("Successfully Logged In"),n.setUserData("id",o.content),e.state=!0,t.path("/main")},function(t){console.log("Could not log in"),"validation_error"===t.data.code&&(Array.isArray(t.data.content)?e.loginErrors=t.data.content:e.validationErrors={username:t.data.content.username,password:t.data.content.password,rememberMe:t.data.content.rememberMe}),e.alerts=[{type:"error",msg:"This is unfortunate, your login and/or password is incorrect"}]})},e.logout=function(){n.logoutSession(n.getUserData().id),e.state=!1,t.path("/")},e.$on("authenticationProvided",function(){e.state=!0})}]),angular.module("Controllers").controller("HomeIndexCtrl",["$scope","UsersServ",function(e,t){e.closeAlert=function(t){e.alerts.splice(t,1)},e.register=function(){var n={username:e.createUserName,password:e.createPassword};e.loginErrors=[],e.validationErrors={},t.registerAccount(n,function(e){console.log("Successfully Created account"),t.setUserData("id",e.content)},function(t){console.log("Could not log in"),"validation_error"===t.data.code&&(Array.isArray(t.data.content)?e.loginErrors=t.data.content:e.validationErrors={username:t.data.content.username,password:t.data.content.password,rememberMe:t.data.content.rememberMe}),e.alerts=[{type:"error",msg:"This is unfortunate, please note your user name may already be taken & passwords should be longer than 8 characters"}]})}}]),angular.module("Controllers").controller("MainIndexCtrl",["$scope","$location","ChildrenServ","PlansServ","RewardsServ","NotificationsServ","UsersServ",function(e,t,n,o,r,i,a){function s(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}var l=a.getUserData();s(l)&&t.path("/"),e.closeAlert=function(t){e.alerts.splice(t,1)},n.server.get({},function(t){var r=t.content;o.server.get({},function(t){n.setChildrenPlans(r,t.content),e.children=n.getChildren();var o=n.countPlans();0===o?(e.largeFill=!0,e.smallFill=!1):1===o?(e.largeFill=!1,e.smallFill=!0):(e.largeFill=!1,e.smallFill=!1)},function(){console.log("No plans")})},function(){console.log("No children"),e.alerts=[{type:"success",msg:"Hey, to get started create a goal or plan with 'Add New' found above this very message."}]}),e.$watch(function(){return i.getNotification()},function(){e.notifications=i.getNotification()},!0),e.$watch(function(){return n.getChildren()},function(){e.children=n.getChildren();var t=n.countPlans();0===t?(e.largeFill=!0,e.smallFill=!1):1===t?(e.largeFill=!1,e.smallFill=!0):(e.largeFill=!1,e.smallFill=!1)},!0),r.server.get({},function(e){r.setRewards(e.content),console.log(e,"<- QUERY")},function(){console.log("Error! No rewards")}),e.$watch(function(){return r.getRewards()},function(){e.rewards=r.getRewards()}),i.server.get({},function(e){i.setNotifications(e.content),console.log(e,"<- QUERY")},function(){console.log("No notifications")}),e.$watch(function(){return i.getNotification()},function(){e.notifications=i.getNotification()})}]).controller("ChildrenSubCtrl",["$scope","PlansServ","ChildrenServ","RewardsServ",function(e,t,n,o){e.isCollapsed=!0,e.purchase=function(e,t){if(n.getNetRibbons(t)-o.getCosts(e)>0){var r={id:t,netRibbon:n.getNetRibbons(t),ribbonCost:o.getCosts(e)};n.server.update({id:0},r,function(e){console.log(e,"<- UPDATE"),e?n.setPurchaseRibbons(r.id,r.netRibbon,r.ribbonCost):console.log("Response did not get picked up")})}else console.log("failed, cannot afford item")},e.removePlan=function(o){t.server.remove({id:o},function(t){if(console.log(t,"<- REMOVE"),t){n.deletePlan(o);var r=n.countPlans();0===r?(e.largeFill=!0,e.smallFill=!1):1===r?(e.largeFill=!1,e.smallFill=!0):(e.largeFill=!1,e.smallFill=!1)}else console.log("Response did not get picked up")})}}]).controller("PlansSubCtrl",["$scope","PlansServ","ChildrenServ","NotificationsServ",function(e,t,n,o){e.openProgress=function(){e.progressBox=!0},e.closeProgress=function(){e.progressBox=!1},e.items=["item1","item2"],e.opts={backdropFade:!0,dialogFade:!0},e.plan.percent=parseInt(100*(e.plan.progress/e.plan.totalIteration),10)+"%",e.plan.colour="#"+(16777215*Math.random()<<0).toString(16),e.updateProgress=function(r,i){if(r.progress=r.progress+1,r.active=1,r.progress===r.totalIteration){r.complete=1;var a={childId:i.id,planId:r.id,noRibbon:r.noRibbon};n.server.update({id:0},a,function(t){console.log(t,"<- UPDATE"),t?(n.setCompletionRibbons(i.id,r.noRibbon),e.progressBox=!1):console.log("Response did not get picked up")})}var s=r.colour;delete r.colour,delete r.percent,t.server.update({id:0},r,function(t){console.log(t,"<- UPDATE"),t?(r.colour=s,r.percent=parseInt(100*(r.progress/r.totalIteration),10)+"%",n.updateProgress(r),e.progressBox=!1,o.server.get({},function(e){o.setNotifications(e.content),console.log(e,"<- QUERY")},function(){console.log("Error! Well this is hawkard")})):console.log("Response did not get picked up")})}}]),angular.module("Directives").directive("animateBar",[function(){return{scope:!0,link:function(e,t){t.bind("mouseenter",function(){t.removeClass().addClass("progress progress-striped active")}),t.bind("mouseout",function(){t.removeClass().addClass("progress")})}}}]),angular.module("Directives").directive("planDialogDir",[function(){return{link:function(e,t,n){t.parent().show(),t.hide().fadeIn("fast").delay(n.planDialogDir).fadeOut("slow",function(){t.is(":last-child")&&t.parent().hide()})}}}]),angular.module("Directives").directive("modalBoxDir",["$parse","$dialog",function(e,t){return{restrict:"EA",terminal:!0,link:function(n,o,r){var i,a=angular.extend({},n.$eval(r.uiOptions||r.bsOptions||r.options)),s=r.modal||r.show;a=angular.extend(a,{template:o.html(),resolve:{$scope:function(){return n}}});var l=t.dialog(a);o.remove(),i=r.close?function(){e(r.close)(n)}:function(){angular.isFunction(e(s).assign)&&e(s).assign(n,!1)},n.$watch(s,function(e){e?l.open().then(function(){i()}):l.isOpen()&&l.close()})}}}]),angular.module("Directives").directive("placeHolderDir",[function(){return{restrict:"A",require:"ngModel",link:function(e,t,n,o){var r,i=function(){t.val(n.placeHolderDir)},a=function(){t.val("")};e.$watch(n.ngModel,function(e){r=e||""}),t.bind("focus",function(){""===r&&a()}),t.bind("blur",function(){""===t.val()&&i()}),o.$formatters.unshift(function(e){return e?e:(i(),r="",n.placeHolderDir)})}}}]),angular.module("Directives").directive("resetModalBoxDir",[function(){return{link:function(e,t){t.on("hidden",function(){$(this).data("modal",null)})}}}]),angular.module("Services").factory("AccountsServ",["$resource",function(e){return e("api/accounts/:id",{},{update:{method:"PUT"}})}]),angular.module("Services").config(["$httpProvider",function(e){e.responseInterceptors.push(["$q","$location",function(e,t){return function(n){return n.then(function(e){return e},function(n){return 403===n.status&&(console.log(n),t.path("/")),e.reject(n)})}}])}]),angular.module("Services").factory("ChildrenServ",["$resource",function(e){var t=[];return{getChildren:function(){return t},setChildrenPlans:function(e,n){for(var o=0;e.length>o;o++){for(var r=[],i=0;n.length>i;i++)e[o].id===n[i].childId&&r.push(n[i]);e[o].plans=r}t=e},countPlans:function(){for(var e=0,n=0;t.length>n;n++)t[n].plans.length>0&&(e+=1);return e},createPlanChild:function(e){for(var n=0;t.length>n;n++)if(t[n].nameOfChild===e.nameOfChild)return t[n].plans===!1?(delete t[n].plans,t[n].plans=[],t[n].plans.push(e),void 0):(t[n].plans.push(e),void 0);var o={id:e.childId,userId:e.userId,nameOfChild:e.nameOfChild,totalRibbon:0,spentRibbon:0,netRibbon:0,totalPlan:0},r=[];r.push(e),o.plans=r,t.push(o)},deletePlan:function(e){for(var n=0;t.length>n;n++){for(var o=t[n].plans,r=0;o.length>r;r++)o[r].id===e&&o.splice(r,1);0===t[n].plans.length&&(t[n].plans=!1)}},updateProgress:function(e){for(var n=0;t.length>n;n++)for(var o=t[n].plans,r=0;o.length>r;r++)o[r].id===e.id&&(t[n].plans[r]=e)},getNetRibbons:function(e){for(var n=0;t.length>n;n++)if(t[n].id===e)return t[n].netRibbon},setPurchaseRibbons:function(e,n,o){for(var r=0;t.length>r;r++)t[r].id===e&&(t[r].spentRibbon=t[r].spentRibbon+o,t[r].netRibbon=t[r].netRibbon-o)},setCompletionRibbons:function(e,n){for(var o=0;t.length>o;o++)t[o].id===e&&(t[o].totalRibbon=t[o].totalRibbon+n,t[o].netRibbon=t[o].netRibbon+n)},server:e("api/offspring/:id",{},{update:{method:"PUT"}})}}]),angular.module("Services").factory("NotificationsServ",["$resource",function(e){var t=[];return{getNotification:function(){return t},setNotifications:function(e){for(var n=0;e.length>n;n++)e[n].percent=parseInt(100*(e[n].progress/e[n].totalIteration),10)+"%";t=e},removeNotifiction:function(e){for(var n=0;t.length>n;n++)t[n].id===e.id&&t.splice(n,1);0===t.length&&(t=!1)},server:e("api/notifications/:id",{},{update:{method:"PUT"}})}}]),angular.module("Services").factory("PlansServ",["$resource",function(e){return{formCheck:function(e){if(void 0===e.titleOfPlan){var t={status:!1,message:"Please enter a name of this goal"};return t}if(3>e.titleOfPlan.length||e.titleOfPlan.length>50){var n={status:!1,message:"Please check your title as it may be too long"};return n}if(void 0===e.description){var o={status:!1,message:"Please enter a description for this goal"};return o}if(3>e.description.length||e.description.length>140){var r={status:!1,message:"Please check the description as it may be too long"};return r}if(void 0===e.nameOfChild){var i={status:!1,message:"Please re try the name of the user"};return i}if(3>e.nameOfChild.length||e.nameOfChild.length>13){var a={status:!1,message:"Please check the user's name as it may be too long"};return a}if(void 0===e.totalIteration){var s={status:!1,message:"Please enter the number of steps for this goal"};return s}if(isNaN(e.totalIteration)){var l={status:!1,message:"Please check that the goal has a number of steps"};return l}if(void 0===e.specificReward){var c={status:!0};return c}if(e.specificReward.length>12){var u={status:!1,message:"Please check name of the reward as it may be too long"};return u}if(void 0===e.noRibbon){var d={status:!1,message:"Please enter the number of ribbons if any for this goal"};return d}if(isNaN(e.noRibbon)){var f={status:!1,message:"Please check that your have selected a number for ribbons"};return f}var g={status:!0};return g},server:e("api/operations/:id",{},{update:{method:"PUT"}})}}]),angular.module("Services").factory("RewardsServ",["$resource",function(e){var t=[];return{getRewards:function(){return t},setRewards:function(e){t=e},setNewReward:function(e){t.push(e)},deleteReward:function(e){for(var n=0;t.length>n;n++)if(t[n].id===e){t.splice(n,1);break}},getCosts:function(e){for(var n=0;t.length>n;n++)if(t[n].id===e)return t[n].ribbonCost},formCheck:function(e){if(void 0===e.titleOfReward){var t={status:!1,message:"Please enter a reward name"};return t}if(3>e.titleOfReward.length||e.titleOfReward.length>30){var n={status:!1,message:"Reward name may be too long"};return n}if(isNaN(e.ribbonCost)){var o={status:!1,message:"Please enter an amount of ribbons for this reward"};return o}if(0===e.ribbonCost){var r={status:!1,message:"Though it would be great, rewards can not be free"};return r}if(e.ribbonCost>99){var i={status:!1,message:"Please keep rewards under 100 ribbons"};return i}var a={status:!0};return a},server:e("api/incentives/:id",{},{update:{method:"PUT"}})}}]),angular.module("Services").factory("SessionsServ",["$resource",function(e){return e("api/sessions/:id",{},{update:{method:"PUT"}})}]),angular.module("Services").config(["$httpProvider",function(e){e.responseInterceptors.push(["$q","$rootScope",function(e,t){return function(n){return n.then(function(e){return e},function(n){if(401===n.status||403===n.status){var o=e.defer(),r={config:n.config,deferred:o};return t.$broadcast("authenticationPartial",r),o.promise}return e.reject(n)})}}])}]).provider("UsersServ",function(){var e={},t="",n="/auth",o=!1,r=[];this.setLoginPage=function(e){n=e},this.$get=["$rootScope","$location","$http","AccountsServ","SessionsServ",function(i,a,s,l,c){var u={getUserData:function(){return e},setUserData:function(t){angular.extend(e,t)},registerAccount:function(e,t,n){l.save({},e,function(n){i.$broadcast("authenticationRegister",e),"function"==typeof t&&t(n)},function(e){"function"==typeof n&&n(e)})},deleteAccount:function(e,t,n){l.remove({id:e},function(n){i.$broadcast("authenticationDestroy",e),"function"==typeof t&&t(n)},function(e){"function"==typeof n&&n(e)})},getAccount:function(t,n,o){l.get({id:t},function(t){e=t.content,i.$broadcast("authenticationProvided",e),"function"==typeof n&&n(t)},function(e){"function"==typeof o&&o(e)})},loginSession:function(e,t,n){c.save({},e,function(e){i.$broadcast("authenticationLogin",e.content),"function"==typeof t&&t(e)},function(e){"function"==typeof n&&n(e)})},logoutSession:function(t,n,o){c.remove({id:t},function(t){i.$broadcast("authenticationLogout",t.content),e={},"function"==typeof n&&n(t)},function(e){"function"==typeof o&&o(e)})},getSession:function(e,t,n){c.get({id:e},function(e){e.content.userId!==void 0&&i.$broadcast("authenticationLogin",e.content.userId),"function"==typeof t&&t(e)},function(e){"function"==typeof n&&n(e)})}};return i.$on("authenticationPartial",function(n,i){0===Object.keys(e).length&&(t="",o=!0,r.push(i))}),i.$on("authenticationFull",function(){0===Object.keys(e).length&&(t=a.path,a.path(n))}),i.$on("authenticationRegister",function(e,n){t="/main",u.loginSession({username:n.username,password:n.password})}),i.$on("authenticationDestroy",function(e,n){t="/",u.logoutSession(n)}),i.$on("authenticationLogin",function(e,n){u.getAccount(n),t&&(a.path(t),t="/main");var i=function(e){s(e.config).then(function(t){e.deferred.resolve(t)},function(t){e.deferred.reject(t)})};if(o){for(var l=0;r.length>l;l++)i(r[l]);o=!1,r=[]}}),i.$on("authenticationLogout",function(){t&&(a.path(t),t="/")}),u}]}).run(["UsersServ",function(e){e.getSession(0)}]);